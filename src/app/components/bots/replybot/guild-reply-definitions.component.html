<div class="guild-reply-definitions-list-container">
  <mat-spinner *ngIf="isLoading"></mat-spinner>
  <div
    class="guild-reply-definitions-container"
    *ngIf="!isLoading && isAuthorizedToAdministrate"
  >
    <app-page-title
      >Custom Reply Definitions for {{ guildName }}</app-page-title
    >
    <div class="navigation-button-section">
      <a [routerLink]="['/bots/replybot']">
        <div class="back-button secondary action button">
          ‚¨ÖÔ∏è Back to Server List
        </div>
      </a>
    </div>
    <div
      class="guild-reply-definition-add-action-section"
      *ngIf="guildReplyDefinitions.length > 0"
    >
      <button
        class="add-guild-reply-definition-button primary action button"
        (click)="addNewGuildReplyDefinition()"
      >
        Create New Reply Definition
      </button>
    </div>
    <div
      class="guild-reply-definition-paste-action-section"
      *ngIf="guildReplyDefinitions.length > 0"
    >
      <button
        class="add-guild-reply-definition-button secondary action button"
        (click)="addFromClipboard()"
      >
        Create From Clipboard üìã
      </button>
    </div>
    <div
      class="filter-options-container"
      *ngIf="guildReplyDefinitions && guildReplyDefinitions.length > 0"
    >
      <div>
        <div class="filter-description">Filter By:</div>
        <mat-button-toggle-group
          class="filter-options-toggle-group"
          name="filterOptions"
          aria-label="filter options"
          [(ngModel)]="filterOptions"
          multiple
        >
          <mat-button-toggle
            *ngFor="let filterType of getFilters()"
            (click)="applyFilters()"
            [value]="filterType"
            [disableRipple]="true"
            >{{ filterType.displayName }}</mat-button-toggle
          >
        </mat-button-toggle-group>
      </div>
      <div class="active-filter-display-text" *ngIf="hasFilters()">
        <span
          >Showing only: {{ getActiveFilterDisplayNames().join(" & ") }}</span
        >
        <button
          class="clear-filters-button tertiary action button"
          (click)="clearFilters()"
        >
          Clear Filters
        </button>
      </div>
    </div>
    <div *ngIf="filteredGuildReplyDefinitions.length === 0">
      <span *ngIf="!hasFilters()">
        No reply definitions are set up for this server yet.
      </span>
      <span *ngIf="hasFilters()">
        No reply definitions match the selected filter criteria.
      </span>
    </div>
    <div
      class="guild-reply-definition-card-container"
      *ngFor="
        let guildReplyDefinition of filteredGuildReplyDefinitions;
        let indexOfReplies = index
      "
    >
      <mat-expansion-panel
        class="guild-reply-definition-card"
        [ngClass]="{
          'guild-reply-definition-card': true,
          'inactive-reply-defintion': !guildReplyDefinition.isActive
        }"
        (opened)="setOpen(indexOfReplies, true)"
        (closed)="setOpen(indexOfReplies, false)"
      >
        <mat-expansion-panel-header>
          <mat-panel-title *ngIf="!getOpen(indexOfReplies)" [ngClass]="">
            {{ guildReplyDefinition.triggers.slice(0, 3).join(", ")
            }}<ng-container *ngIf="guildReplyDefinition.triggers.length > 3"
              >(...)</ng-container
            ></mat-panel-title
          >
          <mat-panel-description *ngIf="!getOpen(indexOfReplies)">
            <mat-chip-set>
              <ng-container *ngFor="let filterType of getAttributes()">
                <mat-chip
                  class="filter-chip"
                  [highlighted]="filterType.filter(guildReplyDefinition)"
                  [disabled]="!filterType.filter(guildReplyDefinition)"
                  [matTooltip]="
                    filterType.valueDisplayText(guildReplyDefinition)
                  "
                  >{{ filterType.displayName }}</mat-chip
                >
              </ng-container>
            </mat-chip-set>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="priority-buttons" *ngIf="!hasFilters()">
          <button
            mat-raised-button
            class="priority-button"
            matTooltip="Move up in priority"
            color="primary"
            [disableRipple]="true"
            [disabled]="indexOfReplies == 0"
            (click)="movePriority('up', guildReplyDefinition)"
          >
            <mat-icon>arrow_upward</mat-icon>
          </button>
          <button
            mat-raised-button
            class="priority-button"
            matTooltip="Move down in priority"
            color="primary"
            [disableRipple]="true"
            [disabled]="
              indexOfReplies == filteredGuildReplyDefinitions.length - 1
            "
            (click)="movePriority('down', guildReplyDefinition)"
          >
            <mat-icon>arrow_downward</mat-icon>
          </button>
        </div>

        <div class="meta-details-section">
          <div class="status-section">
            Status:
            <span class="status-text">{{
              guildReplyDefinition.isActive ? "ON" : "OFF"
            }}</span>
          </div>
        </div>

        <div class="triggers">
          <h2 class="triggers-title">Triggers</h2>
          <div class="trigger">
            <ul>
              <li *ngFor="let trigger of guildReplyDefinition.triggers">
                {{ trigger }}
              </li>
            </ul>
          </div>
          <div class="requires-bot-name">
            <span class="requires-bot-name-title"
              >Trigger Requires Bot Name</span
            >
            <app-check-x
              [isCheck]="guildReplyDefinition.requiresBotName"
            ></app-check-x>
          </div>
        </div>

        <div
          class="channel-ids"
          *ngIf="
            guildReplyDefinition.channelIds &&
            guildReplyDefinition.channelIds.length > 0
          "
        >
          <h2 class="channel-ids-title">Specific Channels</h2>
          <div class="channel-id">
            <ul>
              <li *ngFor="let channelId of guildReplyDefinition.channelIds">
                {{ channelId }}
              </li>
            </ul>
          </div>
        </div>

        <div
          class="user-ids"
          *ngIf="
            guildReplyDefinition.userIds &&
            guildReplyDefinition.userIds.length > 0
          "
        >
          <h2 class="user-ids-title">Specific Users</h2>
          <div class="user-id">
            <ul>
              <li *ngFor="let userId of guildReplyDefinition.userIds">
                {{ userId }}
              </li>
            </ul>
          </div>
        </div>

        <div
          class="replies"
          *ngIf="
            guildReplyDefinition.replies &&
            guildReplyDefinition.replies.length > 0
          "
        >
          <h2 class="replies-title">Replies</h2>
          <div class="response">
            <ul>
              <li *ngFor="let reply of guildReplyDefinition.replies">
                {{ reply }}
              </li>
            </ul>
          </div>
          <div class="mention-author">
            <span class="mention-author-title"
              >Mention Author When Replying</span
            >
            <app-check-x
              [isCheck]="guildReplyDefinition.mentionAuthor"
            ></app-check-x>
          </div>
        </div>

        <div
          class="reactions"
          *ngIf="
            guildReplyDefinition.reactions &&
            guildReplyDefinition.reactions.length > 0
          "
        >
          <h2 class="reactions-title">Reactions</h2>
          <div class="reaction">
            <ul>
              <li *ngFor="let reaction of guildReplyDefinition.reactions">
                {{ reaction }}
              </li>
            </ul>
          </div>
        </div>
        <hr />
        <div class="dates-section">
          <div class="created-info">
            Created On
            <span
              class="edit-date"
              *ngIf="guildReplyDefinition.createdDate"
              [matTooltip]="guildReplyDefinition.createdDate"
              >{{ guildReplyDefinition.createdDate | date }}</span
            >
            <span class="edit-date" *ngIf="!guildReplyDefinition.createdDate"
              >Unknown Date</span
            >
            by
            <span
              class="edit-user"
              *ngIf="guildReplyDefinition.createdById"
              [matTooltip]="guildReplyDefinition.createdById"
              >{{ guildReplyDefinition.createdByUsername }}</span
            >
            <span class="edit-user" *ngIf="!guildReplyDefinition.createdById"
              >Unknown User</span
            >
          </div>
          <div class="updated-info">
            Last Updated On
            <span
              class="edit-date"
              *ngIf="guildReplyDefinition.updatedDate"
              [matTooltip]="guildReplyDefinition.updatedDate"
              >{{ guildReplyDefinition.updatedDate | date }}</span
            >
            <span class="edit-date" *ngIf="!guildReplyDefinition.updatedDate"
              >Unknown Date</span
            >
            by
            <span
              class="edit-user"
              *ngIf="guildReplyDefinition.updatedById"
              [matTooltip]="guildReplyDefinition.updatedById"
              >{{ guildReplyDefinition.updatedByUsername }}</span
            >
            <span class="edit-user" *ngIf="!guildReplyDefinition.updatedById"
              >Unknown</span
            >
          </div>
        </div>

        <div class="guild-reply-definition-action-section">
          <ng-container
            *ngIf="replyDefinitionToDelete?.id === guildReplyDefinition.id"
          >
            <div class="delete-warning">
              Are you sure you want to delete? You cannot undo this!
            </div>
            <div class="delete-warning-actions">
              <button
                class="delete-warning-button danger action button"
                (click)="doDelete()"
              >
                Delete Forever!
              </button>
              <button
                class="delete-warning-button secondary action button"
                (click)="cancelDelete()"
              >
                No! Cancel!
              </button>
            </div>
          </ng-container>
          <ng-container
            *ngIf="replyDefinitionToDelete?.id !== guildReplyDefinition.id"
          >
            <div class="guild-reply-definition-actions">
              <button
                class="guild-reply-definition-action-button secondary action button"
                (click)="addFromCopy(guildReplyDefinition)"
              >
                Create Duplicate
              </button>
              <button
                class="guild-reply-definition-action-button secondary action button"
                (click)="copyJsonToClipboard(guildReplyDefinition)"
              >
                Copy to Clipboard üìã
              </button>
            </div>
            <div class="guild-reply-definition-actions">
              <button
                class="guild-reply-definition-action-button tertiary action button"
                (click)="startEdit(guildReplyDefinition)"
              >
                Edit
              </button>
              <button
                class="guild-reply-definition-action-button danger action button"
                (click)="showDeleteConfirm(guildReplyDefinition)"
              >
                Delete
              </button>
            </div>
          </ng-container>
        </div>
      </mat-expansion-panel>
    </div>
    <div class="guild-reply-definition-add-action-section">
      <button
        mat-raised-button
        class="add-guild-reply-definition-button primary action button"
        color="primary"
        (click)="addNewGuildReplyDefinition()"
      >
        Create New Reply Definition
      </button>
    </div>
    <div class="guild-reply-definition-paste-action-section">
      <button
        mat-raised-button
        class="add-guild-reply-definition-button secondary action button"
        (click)="addFromClipboard()"
      >
        Create From Clipboard üìã
      </button>
    </div>
  </div>
  <div
    class="guild-reply-definitions-container"
    *ngIf="!isLoading && !isAuthorizedToAdministrate"
  >
    You do not have permission to administrate the bot in this server.
  </div>
</div>
